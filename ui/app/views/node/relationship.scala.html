@*{<meta charset="UTF-8" />}*@

@import util.Formatter
@import util.Util
@import util.NemakiConfig
@import component._
@import play.mvc.Http.Context.Implicit
@import org.apache.chemistry.opencmis.client.api.CmisObject
@(repositoryId:String)(obj:CmisObject)(relationships: List[org.apache.chemistry.opencmis.client.api.Relationship])

<div class="container tab-pane">
	<div class="row" style="margin-bottom:15px">
		<div class="col-sm-6 col-md-6">
			@if(Util.isFreezeCopy(obj, Http.Context.current)){
				@lockedNotice(obj)
			}else{
				@if(Util.isPropertyEditable(obj, Http.Context.current)){
					@createButton("create-new-relationship")
				}
			}
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12 col-md-12">
			<legend><i class="fa fa-arrow-circle-o-up"></i>@Messages("view.node.relationship.table.to.caption")</legend>
			<div class="row" style="margin-bottom:15px">
				<div class="col-sm-12 col-md-12">
					@Messages("view.node.relationship.download.targets.label") @executeButton("download-with-target")
				</div>
			</div>
			<table class="footable" id="relationship-table-source">
				<thead>
					<tr>
						<th>@Messages("view.node.relationship.create.type.label")</th>
						<th>@Messages("view.node.relationship.name")</th>
						<th>@Messages("view.node.relationship.target.name")</th>
						<th>@NemakiConfig.getLabel("cmis:createdBy", Implicit.lang().language)</th>
						<th>@NemakiConfig.getLabel("cmis:creationDate", Implicit.lang().language)</th>
						<th data-sort-ignore="true" class="col-sm-2 col-md-2">@Messages("view.action") </th>
					</tr>
				</thead>
				<tbody>
					@for(relationship <- relationships){
							@if(obj.getId() == relationship.getSource().getId()){
							<tr>
								<td>@NemakiConfig.getLabel(relationship.getType().getId(), Implicit.lang().language)</td>
								<td>@relationship.getName()</td>
								<td>@relationship.getTarget().getName()</td>
								<td>@relationship.getCreatedBy()</td>
								<td>@Formatter.calToString(relationship.getCreationDate(), Implicit.lang.toLocale)</td>
								<td>
									<div class="btn-group">
										<button type="button" class="btn btn-default delete" cmis-id="@relationship.getId()">
											<i class="fa fa-unlink"></i><div class="tooltips">@Messages("view.unlink")</div>
										</button>
									</div>
								</td>
							</tr>
						}
					}
				</tbody>
			</table>

			<br/><br/>

			<legend><i class="fa fa-arrow-circle-o-down"></i>@Messages("view.node.relationship.table.from.caption")</legend>
			<table class="footable" id="relationship-table-target">
				<thead>
					<tr>
						<th>@Messages("view.node.relationship.create.type.label")</th>
						<th>@Messages("view.node.relationship.name")</th>
						<th>@Messages("view.node.relationship.source.name")</th>
						<th>@NemakiConfig.getLabel("cmis:createdBy", Implicit.lang().language)</th>
						<th>@NemakiConfig.getLabel("cmis:creationDate", Implicit.lang().language)</th>
						<th data-sort-ignore="true" class="col-sm-2 col-md-2">@Messages("view.action") </th>
					</tr>
				</thead>
				<tbody>
					@for(relationship <- relationships){
							@if(obj.getId() == relationship.getTarget().getId()){
							<tr>
								<td>@NemakiConfig.getLabel(relationship.getType().getId(), Implicit.lang().language)</td>
								<td>@relationship.getName()</td>
								<td>@relationship.getSource().getName()</td>
								<td>@relationship.getCreatedBy()</td>
								<td>@Formatter.calToString(relationship.getCreationDate(), Implicit.lang.toLocale)</td>
								<td>
									<div class="btn-group">
										<button type="button" class="btn btn-default delete" cmis-id="@relationship.getId()">
											<i class="fa fa-unlink"></i><div class="tooltips">@Messages("view.unlink")</div>
										</button>
									</div>
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>
	</div>
</div>

<!-- footable -->
<script type="text/javascript">
	$(function () {
	    $('#relationship-table-source').footable();
	    $('#relationship-table-target').footable();

		$('#create-new-relationship').on('click', function(){
			$.get("@routes.Node.showRelationshipCreate(repositoryId, obj.getId())", function(html){
				showLightbox('relationship-create', html);
			});
		});

		//multiple archive button
		$("#download-with-target").on('click', function(){
			if(window.confirm("@Messages("view.message.compress.confirm")")){
			    $.fileDownload(jsRoutes.controllers.Node.downloadWithRelationTargetAsCompressedFile("@repositoryId", "@obj.getId()").url)
		        .done(function () { })
		        .fail(function (responseHtml, url, error) {
			         window.alert("@Messages("view.message.failure")" + " : " + responseHtml);
			      })
			    .always(function(){	$.unblockUI(); });
			}
		});

		$('.delete').on('click', function(){
			if(window.confirm("@Messages("view.message.delete.confirm")")){
				var id = $(this).attr('cmis-id');

				$.blockUI({message:"@Messages("view.message.please.wait")"});

				//Execute
				$.ajax(jsRoutes.controllers.Node.delete("@repositoryId", id)
				).done(function(data){
					window.alert("@Messages("view.message.delete.success")");
					window.location.reload();
				}).fail(function(XMLHttpRequest, textStatus, errorThrown){
					window.alert("@Messages("view.message.delete.failure")");
				}).always(function(){
					$.unblockUI();
				});
			}
		});

	});
</script>